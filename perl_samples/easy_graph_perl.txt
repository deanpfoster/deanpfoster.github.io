#!/usr/bin/perl

### It's going to be executed by the server so make sure that it 
### is executable by "all".  It is also important NOT to have it world
### readable, or apache won't run it.

 
#############################################################################
#
#   now run gnuplot to generate some output and put it into tmp.jpeg
#   NOTE: tmp.jpeg must be writable by world so apache can write to it.

$plot_string = "plot x*sin(1/(x*x))";

{
    use IPC::Open2;
    local(*Reader, *Writer);
    $pid = open2(\*Reader, \*Writer, "gnuplot");

    print Writer "set terminal jpeg\n";
    print Writer $plot_string;
    close(Writer);
    $filename = "./tmp/graph_".int(rand(999999)).".jpeg";
    open(GIF,">$filename") || die "can't open";
    print GIF while(<Reader>);
    waitpid($pid,0);
}
{
    use IPC::Open2;
    local(*Reader, *Writer);
    $pid = open2(\*Reader, \*Writer, "gnuplot");

    print Writer "set terminal table\n";
    print Writer $plot_string;
    close(Writer);
    open(TABLE,">./tmp.table");
    print TABLE while(<Reader>);
    waitpid($pid,0);
}


#############################################################################
#
# First print a header
#

print "Content-type: text/html\r\n";
print "\r\n";

#############################################################################
#
# Now print out a html page that will mention the jpeg we just created
#

print <<EOF;
<HTML>
<HEAD>
<TITLE> Hello friends! </TITLE>
</HEAD>
<BODY>
<H1> Here is some fresh output generated by gnu plot.</H1>
<p>
<IMG SRC="$filename">
</BODY>
</HTML>
EOF


